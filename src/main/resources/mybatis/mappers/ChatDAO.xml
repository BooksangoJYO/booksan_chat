<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC  "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.booksan.booksan_chat.dao.ChatDAO">
    <!-- 참여중인 채팅방 목록 조회 -->
    <select id="findAllRoomById" resultType="io.booksan.booksan_chat.vo.ChatRoomVO">
        SELECT ROOM_ID, NAME, INSERT_DAYTIME, TYPE
        FROM CHAT_ROOM
        WHERE UID = #{uid}
        AND DISABLED = 'N'
        ORDER BY INSERT_DAYTIME DESC
    </select>

    <select id="findAllRoom" resultType="io.booksan.booksan_chat.vo.ChatRoomVO">
        SELECT ROOM_ID, NAME, INSERT_DAYTIME, TYPE
        FROM CHAT_ROOM
        where DISABLED = 'N'
        ORDER BY INSERT_DAYTIME DESC
    </select>

    
    <select id="findUsersByRoomId" resultType="io.booksan.booksan_chat.vo.UserChatRoomVO">
        SELECT room_id , uid
        FROM USER_CHAT_ROOM
        where room_id = #{roomId}
        ORDER BY INSERT_DAYTIME DESC
    </select>

    <!-- 채팅방 생성 -->
    <insert id="insertChatRoom">
        INSERT INTO CHAT_ROOM (ROOM_ID, NAME, TYPE)
        VALUES (#{roomId}, #{name}, "private")
    </insert>


    <!-- 채팅방 제거 -->
    <update id="deleteChatRoom">
        UPDATE CHAT_ROOM
        SET DISABLED = 'Y'
        WHERE ROOM_ID = #{sessionId}
    </update>

    <!-- 사용자 채팅방 입장 -->
    <insert id="insertUserChatRoom">
        INSERT INTO USER_CHAT_ROOM (ROOM_ID, UID)
        VALUES (#{roomId}, #{uid})
    </insert>

    <!-- 사용자 채팅방 퇴장 -->
    <update id="deleteUserChatRoom">
        UPDATE USER_CHAT_ROOM
        SET EXIT_DAYTIME = NOW(),
            DISABLED = 'Y'
        WHERE ROOM_ID = #{roomId}
        AND UID = #{uid}
    </update>

    <!-- 채팅 메시지 등록 -->
    <insert id="insertChatMessage">
        INSERT INTO CHAT_MESSAGE (ROOM_ID, UID, CONTENT)
        VALUES (#{roomId}, #{uid}, #{content})
    </insert>

    <select id="getUidByEmail">
        SELECT uid
        FROM USERS
        WHERE email = #{email}
        AND DISABLED = 'N'
    </select>

    <select id="getNicknameByEmail">
        SELECT nickname
        FROM USERS
        WHERE email = #{email}
        AND DISABLED = 'N'
    </select>

    <select id="getEmailbyUid">
        SELECT email
        FROM USERS
        WHERE uid = #{uid}
        AND DISABLED = 'N'
    </select>

    <select id="getMessage" resultType="io.booksan.booksan_chat.vo.ChatMessageVO">
        SELECT *
        FROM CHAT_MESSAGE
        WHERE room_id = #{roomId}
    </select>


</mapper>