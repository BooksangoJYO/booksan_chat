<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC  "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.booksan.booksan_chat.dao.ChatDAO">
    <!-- 참여중인 채팅방 목록 조회 -->
    <select id="findAllRoomById" resultType="io.booksan.booksan_chat.vo.ChatRoomVO">
        SELECT ROOM_ID, NAME, INSERT_DAYTIME, TYPE
        FROM CHAT_ROOM
        WHERE UID = #{uid}
        AND DISABLED = 'N'
        ORDER BY INSERT_DAYTIME DESC
    </select>

    <!-- 채팅방 생성 -->
    <insert id="insertChatRoom">
        INSERT INTO CHAT_ROOM (ROOM_ID, NAME, TYPE)
        VALUES (#{roomId}, #{name}, #{type})
    </insert>

    <!-- 채팅방 찾기 -->
    <select id="findRoomSessionId" resultType="io.booksan.booksan_chat.vo.ChatRoomVO">
        SELECT ROOM_ID, NAME, INSERT_DAYTIME, TYPE
        FROM CHAT_ROOM
        WHERE ROOM_ID = #{sessionId}
        AND DISABLED = 'N'
    </select>

    <!-- 채팅방 제거 -->
    <update id="deleteChatRoom">
        UPDATE CHAT_ROOM
        SET DISABLED = 'Y'
        WHERE ROOM_ID = #{sessionId}
    </update>

    <!-- 사용자 채팅방 입장 -->
    <insert id="insertUserChatRoom">
        INSERT INTO USER_CHAT_ROOM (ROOM_ID, UID, INSERT_DAYTIME)
        VALUES (#{roomId}, #{uid}, NOW())
        <selectKey resultType="io.booksan.booksan_chat.vo.ChatRoomVO" keyProperty="roomId" order="AFTER">
            SELECT ROOM_ID, NAME, INSERT_DAYTIME, TYPE
            FROM CHAT_ROOM
            WHERE ROOM_ID = #{roomId}
        </selectKey>
    </insert>

    <!-- 사용자 채팅방 퇴장 -->
    <update id="deleteUserChatRoom">
        UPDATE USER_CHAT_ROOM
        SET EXIT_DAYTIME = NOW(),
            DISABLED = 'Y'
        WHERE ROOM_ID = #{roomId}
        AND UID = #{uid}
    </update>

    <!-- 채팅 메시지 등록 -->
    <insert id="insertChatMessage">
        INSERT INTO CHAT_MESSAGE (ROOM_ID, UID, CONTENT)
        VALUES (#{roomId}, #{uid}, #{content}, NOW())
    </insert>
</mapper>